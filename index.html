<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Network Wallet | Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root {
            --pi-purple: #6d1e7f;
            --pi-gold: #ffca28;
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-dim: #b0b0b0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 450px;
            perspective: 1000px;
        }

        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            border: 1px solid #333;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .logo {
            width: 80px;
            height: 80px;
            background: var(--pi-purple);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            font-weight: bold;
            color: var(--pi-gold);
            box-shadow: 0 0 20px rgba(109, 30, 127, 0.5);
        }

        h2 { margin-bottom: 10px; font-weight: 600; }
        p { color: var(--text-dim); font-size: 14px; margin-bottom: 25px; }

        .input-group {
            text-align: right;
            margin-bottom: 20px;
        }

        label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--pi-gold); }

        input {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #444;
            background: #252525;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            transition: border 0.3s;
        }

        input:focus { border-color: var(--pi-purple); }

        .btn-withdraw {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--pi-purple), #4a148c);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .btn-withdraw:disabled { background: #444; cursor: not-allowed; }
        .btn-withdraw:active { transform: scale(0.98); }

        #status-box {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .success { background: rgba(76, 175, 80, 0.1); color: #4caf50; border: 1px solid #4caf50; }
        .error { background: rgba(244, 67, 54, 0.1); color: #f44336; border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.1); color: #2196f3; border: 1px solid #2196f3; }

        /* Animation Ù„Ù„ØªØ­Ù…ÙŠÙ„ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="logo">Ï€</div>
        <h2>Ø³Ø­Ø¨ Ø¹Ù…Ù„Ø§Øª Pi</h2>
        <p id="user-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© Ø¯Ø§Ø®Ù„ Pi Browser...</p>

        <div class="input-group">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</label>
            <input type="text" id="walletAddr" placeholder="G..." autocomplete="off">
        </div>

        <div class="input-group">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ© (Amount)</label>
            <input type="number" id="amount" placeholder="0.00" step="0.01">
        </div>

        <button id="withdrawBtn" class="btn-withdraw" disabled>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</button>

        <div id="status-box"></div>
    </div>
</div>

<script>
    const Pi = window.Pi;
    let currentUser = null;

    // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ SDK
    Pi.init({ version: "2.0", sandbox: false });

    async function initializeApp() {
        const btn = document.getElementById('withdrawBtn');
        const status = document.getElementById('status-box');
        const userDisplay = document.getElementById('user-display');

        try {
            // 2. Ø·Ù„Ø¨ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const scopes = ['payments', 'username'];
            currentUser = await Pi.authenticate(scopes, (payment) => {
                console.log("Ø¯ÙØ¹Ø© Ù…Ø¹Ù„Ù‚Ø© Ù…ÙƒØªØ´ÙØ©:", payment);
            });

            userDisplay.innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.user.username}`;
            btn.disabled = false;
            btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†";
        } catch (err) {
            showStatus("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø³Ø­Ø¨.", "error");
            userDisplay.innerText = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function showStatus(msg, type) {
        const box = document.getElementById('status-box');
        box.className = type;
        box.innerHTML = msg;
        box.style.display = 'block';
    }

    document.getElementById('withdrawBtn').onclick = async () => {
        const addr = document.getElementById('walletAddr').value;
        const amt = document.getElementById('amount').value;
        const btn = document.getElementById('withdrawBtn');

        if (!addr || !amt) return showStatus("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª", "error");

        // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
        showStatus("ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¢Ù…Ù†...", "info");

        try {
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù€ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Vercel
            const response = await fetch('/api/withdraw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    walletAddress: addr,
                    amount: amt,
                    uid: currentUser.user.uid
                })
            });

            const result = await response.json();

            if (result.success) {
                showStatus(`ğŸš€ ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!<br>Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙØ¹: ${result.paymentId.substring(0,15)}...`, "success");
                btn.innerHTML = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­";
            } else {
                showStatus("Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + (result.message || "ÙØ´Ù„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"), "error");
                btn.disabled = false;
                btn.innerText = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            }
        } catch (error) {
            showStatus("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ±", "error");
            btn.disabled = false;
            btn.innerText = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©";
        }
    };

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    initializeApp();
</script>

</body>
</html>
