<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Ecosystem Wallet</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #673ab7;
            --secondary-color: #ff9800;
            --bg-color: #f4f7f6;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; transition: 0.3s; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 420px;
            background: white;
            border-radius: 24px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }

        /* شاشة تسجيل الدخول */
        #login-section i { font-size: 60px; color: var(--secondary-color); margin-bottom: 20px; }
        
        /* شاشة التطبيق الرئيسية */
        #main-section { display: none; }

        .user-card {
            display: flex;
            align-items: center;
            background: #f9f9f9;
            padding: 12px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .avatar {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-left: 12px;
        }

        .balance-display {
            background: linear-gradient(45deg, var(--primary-color), #9575cd);
            color: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
        }

        .balance-display h2 { margin: 5px 0; font-size: 32px; }

        .input-group { text-align: right; margin-bottom: 15px; }
        .input-group label { font-size: 14px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }

        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            outline: none;
        }

        input:focus { border-color: var(--primary-color); }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-login { background: #333; color: white; }
        .btn-deposit { background: var(--primary-color); color: white; }
        .btn-withdraw { background: var(--secondary-color); color: white; }

        button:active { transform: scale(0.97); }

        #status-bar {
            margin-top: 20px;
            font-size: 14px;
            padding: 10px;
            border-radius: 8px;
            min-height: 40px;
        }

        .loading-dots:after { content: '...'; animation: dots 1.5s infinite; }
        @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <i class="fab fa-pi-network"></i>
        <h1>Pi Hub</h1>
        <p>مرحباً بك! سجل دخولك للمتابعة</p>
        <button class="btn-login" onclick="login()">
            <i class="fas fa-sign-in-alt"></i> دخول عبر Pi Network
        </button>
    </div>

    <div id="main-section">
        <div class="user-card">
            <div class="avatar" id="user-icon">?</div>
            <div style="text-align: right;">
                <div id="user-display-name" style="font-weight: bold;">@Username</div>
                <div style="font-size: 11px; color: #888;">حساب موثق</div>
            </div>
        </div>

        <div class="balance-display">
            <small>الرصيد المتاح للتجربة</small>
            <h2 id="balance-val">10.00 Pi</h2>
        </div>

        <div class="input-group">
            <label>إرسال Pi للتطبيق (إيداع)</label>
            <input type="number" id="dep-amount" value="1.0" step="0.1">
            <button class="btn-deposit" onclick="handleDeposit()">
                <i class="fas fa-arrow-up"></i> إرسال الآن
            </button>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

        <div class="input-group">
            <label>سحب Pi للمحفظة</label>
            <input type="number" id="with-amount" value="0.1" step="0.1">
            <button class="btn-withdraw" onclick="handleWithdraw()">
                <i class="fas fa-wallet"></i> سحب فوري
            </button>
        </div>

        <div id="status-bar"></div>
    </div>
</div>

<script>
    const Pi = window.Pi;
    Pi.init({ version: "2.0", sandbox: false });

    // الرابط المختصر المعرف في vercel.json
    const API_ENDPOINT = "/process-payment"; 
    let currentUser = null;

    // دالة تسجيل الدخول
    async function login() {
        try {
            updateStatus("جاري التحقق...", "#666");
            const auth = await Pi.authenticate(['payments', 'username'], onIncompletePayment);
            
            currentUser = auth.user;
            document.getElementById('user-display-name').innerText = "@" + currentUser.username;
            document.getElementById('user-icon').innerText = currentUser.username[0].toUpperCase();
            
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            updateStatus("تم الدخول بنجاح", "green");
        } catch (err) {
            updateStatus("فشل الدخول: " + err.message, "red");
        }
    }

    // دالة الإيداع (من المستخدم للتطبيق)
    async function handleDeposit() {
        const amount = document.getElementById('dep-amount').value;
        updateStatus("جاري فتح المحفظة...", "orange");

        try {
            const payment = await Pi.createPayment({
                amount: parseFloat(amount),
                memo: "Deposit to App",
                metadata: { type: "deposit" }
            }, {
                onReadyForServerApproval: (id) => updateStatus("بانتظار موافقة السيرفر...", "blue"),
                onReadyForServerCompletion: async (id, txid) => {
                    updateStatus("جاري تأكيد المعاملة...", "orange");
                    await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            action: 'complete-deposit', 
                            paymentData: {paymentId: id, txid: txid}, 
                            amount: amount, 
                            uid: currentUser.uid 
                        })
                    });
                    updateStatus("✅ تم الإيداع بنجاح!", "green");
                },
                onCancel: () => updateStatus("تم إلغاء الدفع", "#666"),
                onError: (err) => updateStatus("خطأ: " + err.message, "red")
            });
        } catch (err) { updateStatus(err.message, "red"); }
    }

    // دالة السحب (من التطبيق للمستخدم)
    async function handleWithdraw() {
        const amount = document.getElementById('with-amount').value;
        updateStatus("جاري معالجة السحب السريع...", "orange");

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    action: 'withdraw', 
                    amount: amount, 
                    walletAddress: "G...", // تأكد من استبدالها بمحفظة الاختبار الخاصة بك
                    uid: currentUser.uid 
                })
            });

            const data = await response.json();
            if (data.success) {
                updateStatus(`✅ نجح السحب!<br><small>Memo: ${data.memo}</small>`, "green");
            } else {
                updateStatus("⚠️ " + data.message, "red");
            }
        } catch (err) {
            updateStatus("فشل الاتصال بالسيرفر", "red");
        }
    }

    function onIncompletePayment(payment) {
        // يمكن هنا استدعاء الـ API لإكمال أي دفعة لم تكتمل
        console.log("Incomplete payment found:", payment);
    }

    function updateStatus(msg, color) {
        const statusDiv = document.getElementById('status-bar');
        statusDiv.innerHTML = msg;
        statusDiv.style.color = color;
    }
</script>

</body>
</html>
